## Authenticating Users in Kubernetes

Kubernetes supports a number of authentication methods for requests against the API server including:

* Certificates
* Bearer Tokens
* Passwords 
* OpenID Connect Tokens

The default ACS install and `kube config` set things up with authenticating the user with a certificate.  If one looks in the file `~/.kube/config`, one sees something like:

```
users:
- name: "jmsk8-admin"
  user:
    client-certificate-data: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlEUkRDQ0FpeWdBd0lCQWdJSVlmNVB2MFVOcWFjd0RRWUpLb1pJaHZjTkFRRUxCUUF3RX
pFUk1BOEdBMVVFQXd3SVlXTnphemh6DQpZMkV3SGhjTk1UY3dNekl5TURBd01EQXdXaGNOTVRrd016SXlNREF3TURBd1dqQVZNUk13RVFZRFZRUUREQXByZFdKbFkyOXVabWxuDQpNSU
lCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXYzUWJ6T2dqYkdQRm1CVVdDRlozQ2FhZ1luN1hHREdBDQpFdUQ3ckZJT3ZSYlVsNlhDQis5Sy9KblNsRktzT0
MzT1ZBNUQrb3JXWVR2eVVraXhPbXhhaUFsN3FjUjdtK3d2c0E2VStyL3pBV1ZmDQpKUmNNL09MSHRRcGpVc2c5R1NhaUxyZitPS3MxUXFkTndqakhWZ3RrVnhRdi8yL0hmaEFhL0tuKz
hiOW80Rko1ZWFrSTl0U3JXUkZ2DQpmc1R3TmpQRFJ0VDB2cnFvcHZlYjNRZGRBdHNVNld3MUJnaUh3NTVPSW1TMStWQldSZ3F5YTAyajd1dDlpME1raHNJK3Q5YmFNVDBxDQpuMEY0T1
B6WGdxV2x5YTk4c3N5UUFpMmsvQVRvNWlscHhaOXN5dWFtZW8wZG1kUm8xK1BWZ1JrbWREdmwvQmRqNm8xbzNJQ0VhZ3h4DQorQ2JXYXdJREFRQUJvNEdaTUlHV01FSUdBMVVkSXdRN0
1EbUFGRTNNMXdDWm9ISGJMRE9zQzAra1lEN2JDSkV6b1Jla0ZUQVRNUkV3DQpEd1lEVlFRRERBaGhZM05yT0hOallZSUlJa2Y4NmdLK2NORXdIUVlEVlIwT0JCWUVGS2hOa3M5b3VRbD
lJUEEzUExnQStMalNxZCtmDQpNQXdHQTFVZEV3RUIvd1FDTUFBd0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dBUVVGQndNQ01BMEdDU3FHDQpTSWIzRFFFQk
N3VUFBNElCQVFBQzR2elB5NjZDMGFoZ1NSZzF1b1JMTjIrYk1rVVF1V2dVamlsTlMxelNFbXQ3NnlzdE4xNVVUZ3lWDQplaWxHcHVVM2tGVEh5VEo3WW5rTExDRytWTmV1K0dBZnVqVm
lrcGFYRmJ2VVQrM05PMExGT01oWWRPNWxGckxqQlpHenFzU0p5ME5SDQpubWlsNlhTY2JPRVlwMTlVbDdEL3NrMS8wYmwra0l6U2ZRK2crd01BaDJRcXFpYnREcHRsQ0tQOXJ5MElPVF
I0SUVIQ04xQ2gxdWhSDQpxWk95YWxvdG9UcmFUZTlQdjg3NUxHUGFDMlQ2elBzMFZ5WCtEV1A4ZnRTdW0ybnlySGlFZVdpTGR0K29jczVIRGdCY3B0aU11NlhTDQpNUFdwaC9jbHJvU0
hiQ2xaUGllQUZSOEF3dHFMdzVYMUI5QXpadjh6QUFRTWlkTWk0SEZDRWN5SQ0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ0K"
    client-key-data: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQ0KTUlJRW93SUJBQUtDQVFFQXYzUWJ6T2dqYkdQRm1CVVdDRlozQ2FhZ1luN1hHREdBRXVEN3JGSU
92UmJVbDZYQw0KQis5Sy9KblNsRktzT0MzT1ZBNUQrb3JXWVR2eVVraXhPbXhhaUFsN3FjUjdtK3d2c0E2VStyL3pBV1ZmSlJjTQ0KL09MSHRRcGpVc2c5R1NhaUxyZitPS3MxUXFkTn
dqakhWZ3RrVnhRdi8yL0hmaEFhL0tuKzhiOW80Rko1ZWFrSQ0KOXRTcldSRnZmc1R3TmpQRFJ0VDB2cnFvcHZlYjNRZGRBdHNVNld3MUJnaUh3NTVPSW1TMStWQldSZ3F5YTAyag0KN3
V0OWkwTWtoc0krdDliYU1UMHFuMEY0T1B6WGdxV2x5YTk4c3N5UUFpMmsvQVRvNWlscHhaOXN5dWFtZW8wZA0KbWRSbzErUFZnUmttZER2bC9CZGo2bzFvM0lDRWFneHgrQ2JXYXdJRE
FRQUJBb0lCQUFIaG5qUlJRNmZaQXlRUA0KY1B2Ny9ZZDJ2N1M0RWwwR2YzK3Yva2tmTlUzZVg1QnQ3STR2WjhrN3Fib1RaZVhYYldPZUVFVHlBRkZNU1lGTg0KZlpCWmFEcFYvWVVaal
MxbkVNRG1JOGlqQWp4TlJyWVNsK29VUUdvakEvN1lRT0Z5WTcyWnlVRzlUUFN1dUREaw0KWmZFT2c1bm5kT0ZKcytnbE9GNnJQUG9iSzJpbzRtN08vb1psTTRmMDNZQW1sTjF4QkNRcC
tFMk5KRnNCczhFbg0KaC9sT1BodFpkSGkvMVAzaGVzd1N6VVZieXZld0F1OGFlUUc3bk5BQ3dUbm9RNkRyMk05bjhVUHJIK0lxd2hnaw0KS1IzQmJvTnI1ZlFJL203RlQ2Z1c2Wjh0Um
NpRWlNVm5GdVg4bTZUbXFEajZxYWtUZlpCU0x1Rlo0OG8yZEFXQw0KWjdrajZJRUNnWUVBK2FKYlNkZ0FyRXRSL2lmY3NjZ2d0SGJvYTAzekRtQnFhMnlYR20zM2R1ZUpCU1NYbW8vNQ
0KR2tLTGdDS052TGp4RElIR0p2VmxSTXJsaFlEcmZJMUlGaXRtdlpnMlZKK2NGZmFwZVZZTFFyblF3R2pHRmx0Rg0KcERzYlF0UmVQZDBReDA2cTM2YVppbTVKNTFmZHVlcFNyc0RUNV
lCWmUvL1hhbUQweWJUSkMvc0NnWUVBeEZYdw0KL2l1b1RJR3FNVlZJMVhvTUVZWHhIeGpBZkFGY1k4YVYrUnNwMEVHcUJCS2N3WmJXT1o0Rk1waFRLblFRcDlxbw0KMWUrODNLMTArdn
Uwd2JIcjVCNzZ1djd3TDg1ajFSQ25ab1cxbkRlZ29ZT1A2dkh4TDNES3NISjlPVmtKMU54dg0KbzBsS0h3RlZIR3JlSnE0R1lLWGwvMlVnWkJOcnlvd2FXUERVWkZFQ2dZQk1HZVd3aG
t2Mk9tUDlraE5pa3pyOQ0KS1A3RHI1aTRPa1pYQjF5dEx2Ync1YmJNdlpJR0NYd01PRnNrcmVQOXMzZXdzMk0vL3pGbkhsK0lLbndmbFVaeg0KazdtWGRPNmpMNkU2eE41M1lmYSsyYn
k4MjNQLzNzVkZRc3VWdlA0WjUrbTBpTlBvcUhaSVVFVHhaTVR3WjNIYg0KV21kK29Ia25KeUI1aXFNMVZvcXZ2d0tCZ1FDZ0E3OHZHQnZKaHVCVDVzTStvWUxXZ1VpOFpHcjBaaE9MaW
gxTw0KOGxHSTF3dWUyQ0NFTXRBVUUzTC9BbUM5dCt5Zk1UbnJhc0dOUloyU3RMUmtMUU1wWUFwUGYxbjRUSWpXN1FUUw0KTE9XUUZWSkljTFpKOExmMlIwSWF2cVRLcVlPMnhaWURDY2
RzTDZUVFRWSVRTa0FPWXdkcHVGekcwNEZGaWh3cg0KSXRTbmtRS0JnR3hPQlhOQ1o2MVZXcmc5VlBqLzR0WFZDdzVDVTZoZUFKYmJhcHp2MUlWN3I1UThBbkxiWDhDUg0KcnQrU1BLZD
NxWUZQd1EwZlh3dk5RbnZBSUNEeGtmbEk3OTUydXhTanNoSks1VzYzRHFwam9YQTU2dE1jL3dHQQ0KQmtLdXpIanFSSXpyRmhSOU9ZSmVpaDlhQU02Wmd1Z0FzUTEvRnVRUEJUOXFvUk
dtTWFxbw0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0NCgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
```

Kubernetes verifies each authentication method as mandated by the type, that said, it does not integrate with external sources.  This includes OpenID Connect ID Tokens.  It is up to the user to authenticate and supply the information.

Kubernetes authentication options are documented [here](https://kubernetes.io/docs/admin/authentication).

To integrate with Okta, it is most likely the OpenID Connect approach that one will want to use, also known as OIDC token.

Cole Mickens documents how to set up OIDC with Kubernetes [here](https://github.com/colemickens/azure-ad-k8s-oidc-example).

In order to use an OIDC, when using `kubectl`, one has to specify the token information on the command line as such:

```
kubectl --token=eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL21sYi50cmVtb2xvLmxhbjo4MDQzL2F1dGgvaWRwL29pZGMiLCJhdWQiOiJrdWJlcm5ldGVzIiwiZXhwIjoxNDc0NTk2NjY5LCJqdGkiOiI2RDUzNXoxUEpFNjJOR3QxaWVyYm9RIiwiaWF0IjoxNDc0NTk2MzY5LCJuYmYiOjE0NzQ1OTYyNDksInN1YiI6Im13aW5kdSIsInVzZXJfcm9sZSI6WyJ1c2VycyIsIm5ldy1uYW1lc3BhY2Utdmlld2VyIl0sImVtYWlsIjoibXdpbmR1QG5vbW9yZWplZGkuY29tIn0.f2As579n9VNoaKzoF-dOQGmXkFKf1FMyNV0-va_B63jn-_n9LGSCca_6IVMP8pO-Zb4KvRqGyTP0r3HkHxYy5c81AnIh8ijarruczl-TK_yF5akjSTHFZD-0gRzlevBDiH8Q79NAr-ky0P4iIXS8lY9Vnjch5MF74Zx0c3alKJHJUnnpjIACByfF2SCaYzbWFMUNat-K1PaUk5-ujMBG7yYnr95xD-63n8CO8teGUAAEMx6zRjzfhnhbzX-ajwZLGwGUBT4WqjMs70-6a7_8gZmLZb2az1cZynkFRj2BaCkVT3A2RrjeEwZEtGXlMqKJ1_I2ulrOVsYx01_yD35-rw get nodes
```

It should be noted, using this method, if the token expires then one will need to do the handshake to get a new token.

Kubernetes also has a method, where, if one does the initial handshake with the Identity Provider and gets the `id_token`, `refresh_token` and other information, it will actually handle the process of renewing the token for you.  The config for such would resemble:

```
kubectl config set-credentials mmosley  \
        --auth-provider=oidc  \
        --auth-provider-arg=idp-issuer-url=https://oidcidp.tremolo.lan:8443/auth/idp/OidcIdP  \
        --auth-provider-arg=client-id=kubernetes  \
        --auth-provider-arg=client-secret=1db158f6-177d-4d9c-8a8b-d36869918ec5  \
        --auth-provider-arg=refresh-token=q1bKLFOyUiosTfawzA93TzZIDzH2TNa2SMm0zEiPKTUwME6BkEo6Sql5yUWVBSWpKUGphaWpxSVAfekBOZbBhaEW+VlFUeVRGcluyVF5JT4+haZmPsluFoFu5XkpXk5BXqHega4GAXlF+ma+vmYpFcHe5eZR+slBFpZKtQA= \
        --auth-provider-arg=idp-certificate-authority=/root/ca.pem \
        --auth-provider-arg=id-token=eyJraWQiOiJDTj1vaWRjaWRwLnRyZW1vbG8ubGFuLCBPVT1EZW1vLCBPPVRybWVvbG8gU2VjdXJpdHksIEw9QXJsaW5ndG9uLCBTVD1WaXJnaW5pYSwgQz1VUy1DTj1rdWJlLWNhLTEyMDIxNDc5MjEwMzYwNzMyMTUyIiwiYWxnIjoiUlMyNTYifQ.eyJpc3MiOiJodHRwczovL29pZGNpZHAudHJlbW9sby5sYW46ODQ0My9hdXRoL2lkcC9PaWRjSWRQIiwiYXVkIjoia3ViZXJuZXRlcyIsImV4cCI6MTQ4MzU0OTUxMSwianRpIjoiMm96US15TXdFcHV4WDlHZUhQdy1hZyIsImlhdCI6MTQ4MzU0OTQ1MSwibmJmIjoxNDgzNTQ5MzMxLCJzdWIiOiI0YWViMzdiYS1iNjQ1LTQ4ZmQtYWIzMC0xYTAxZWU0MWUyMTgifQ.w6p4J_6qQ1HzTG9nrEOrubxIMb9K5hzcMPxc9IxPx2K4xO9l-oFiUw93daH3m5pluP6K7eOE6txBuRVfEcpJSwlelsOsW8gb8VJcnzMS9EnZpeA0tW_p-mnkFc3VcfyXuhe5R3G7aa5d8uHv70yJ9Y3-UhjiN9EhpMdfPAoEB9fYKKkJRzF7utTTIPGrSaSU6d2pcpfYKaxIwePzEkT4DfcQthoZdy9ucNvvLoi1DIC-UocFD8HLs8LYKEqSxQvOcvnThbObJ9af71EwmuE21fO5KzMW20KtAeget1gnldOosPtz1G5EwvaQ401-RPQzPGMVBld0_zMCAwZttJ4knw
```

### Options for integration

CoreOS has an open source project known as [dex](https://github.com/coreos/dex) which can be used as a Kubernetes authenticator.  Documentation for integrating it as such is [here](https://github.com/coreos/dex/blob/master/Documentation/kubernetes.md).  Okta provides an OpenID Connect authentication method, initially documented [here](http://developer.okta.com/docs/api/resources/oidc.html).